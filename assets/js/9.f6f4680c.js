(window.webpackJsonp=window.webpackJsonp||[]).push([[9],{189:function(r,e,t){"use strict";t.r(e);var a=t(0),n=Object(a.a)({},function(){var r=this,e=r.$createElement,t=r._self._c||e;return t("ContentSlotsDistributor",{attrs:{"slot-key":r.$parent.slotKey}},[t("h1",{attrs:{id:"實作-web-instance"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#實作-web-instance","aria-hidden":"true"}},[r._v("#")]),r._v(" 實作 Web Instance")]),r._v(" "),t("h2",{attrs:{id:"實作資源"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#實作資源","aria-hidden":"true"}},[r._v("#")]),r._v(" 實作資源")]),r._v(" "),t("ul",[t("li",[t("a",{attrs:{href:"https://www.terraform.io/docs/providers/aws/d/ami.html",target:"_blank",rel:"noopener noreferrer"}},[r._v("data aws_ami"),t("OutboundLink")],1)]),r._v(" "),t("li",[t("a",{attrs:{href:"https://www.terraform.io/docs/providers/aws/r/instance.html",target:"_blank",rel:"noopener noreferrer"}},[r._v("resource aws_instance"),t("OutboundLink")],1)]),r._v(" "),t("li",[t("a",{attrs:{href:"https://www.terraform.io/docs/providers/aws/r/security_group.html",target:"_blank",rel:"noopener noreferrer"}},[r._v("resource aws_security_group"),t("OutboundLink")],1)]),r._v(" "),t("li",[t("a",{attrs:{href:"https://www.terraform.io/docs/providers/aws/r/security_group_rule.html",target:"_blank",rel:"noopener noreferrer"}},[r._v("resource aws_security_group_rule"),t("OutboundLink")],1)]),r._v(" "),t("li",[t("a",{attrs:{href:"https://www.terraform.io/docs/providers/aws/r/elb.html",target:"_blank",rel:"noopener noreferrer"}},[r._v("resource aws_elb"),t("OutboundLink")],1)]),r._v(" "),t("li",[t("a",{attrs:{href:"https://www.terraform.io/docs/providers/aws/r/elb_attachment.html",target:"_blank",rel:"noopener noreferrer"}},[r._v("resource aws_elb_attachment"),t("OutboundLink")],1)])]),r._v(" "),t("h2",{attrs:{id:"實作目標"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#實作目標","aria-hidden":"true"}},[r._v("#")]),r._v(" 實作目標")]),r._v(" "),t("ol",[t("li",[r._v("使用 data 搜尋到 Ubuntu 18.04 的 AMI-ID")]),r._v(" "),t("li",[r._v("建立 Ubuntu 18.04 的 EC2 instance")]),r._v(" "),t("li",[r._v("使用 user data 安裝 apache")]),r._v(" "),t("li",[r._v("使用 count 建立多台 instance 並且掛上 ELB")])]),r._v(" "),t("h2",{attrs:{id:"lab-start"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#lab-start","aria-hidden":"true"}},[r._v("#")]),r._v(" LAB Start")]),r._v(" "),t("ul",[t("li",[t("strong",[r._v("main.tf")])])]),r._v(" "),t("div",{staticClass:"language-terraform extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[r._v('provider "aws" {\n  region = "us-west-2"\n}\n\ndata "aws_ami" "ubuntu" {\n  most_recent = true\n\n  filter {\n    name   = "name"\n    values = ["ubuntu/images/hvm-ssd/ubuntu-bionic-18.04-amd64-server-*"]\n  }\n\n  filter {\n    name   = "virtualization-type"\n    values = ["hvm"]\n  }\n\n  owners = ["099720109477"] # Canonical\n}\n')])])]),t("ul",[t("li",[t("strong",[r._v("security-groups.tf")]),r._v(" 定義 security groups")])]),r._v(" "),t("div",{staticClass:"language-terraform extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[r._v('resource "aws_security_group" "elb" {\n  name_prefix = "terraform-101-elb-"\n  description = "allow all outcomming traffic"\n\n  ingress {\n    from_port   = 80\n    to_port     = 80\n    protocol    = "tcp"\n    cidr_blocks = ["0.0.0.0/0"]\n  }\n\n  tags = {\n    Name = "terraform-101-elb-sg"\n  }\n}\n\nresource "aws_security_group" "web" {\n  name_prefix = "terraform-101-web-"\n  description = "allow all outcomming traffic"\n\n  tags = {\n    Name = "terraform-101-web-sg"\n  }\n}\n\nresource "aws_security_group_rule" "web-rule" {\n  type            = "ingress"\n  from_port       = 80\n  to_port         = 80\n  protocol        = "tcp"\n\n  source_security_group_id = "${aws_security_group.elb.id}"\n\n  security_group_id = "${aws_security_group.web.id}"\n}\n')])])]),t("ul",[t("li",[t("strong",[r._v("ec2.tf")]),r._v(" 定義 ec2 instance")])]),r._v(" "),t("div",{staticClass:"language-terraform extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[r._v('resource "aws_instance" "web" {\n  count = 2\n\n  ami             = "${data.aws_ami.ubuntu.id}"\n  instance_type   = "t3.nano"\n  security_groups = ["${aws_security_group.web.id}"]\n\n  \n\n  user_data = <<-EOF\n                #!/bin/bash\n                apt update && apt-get install -y apache2\n                echo `hostname` > /var/www/html/index.html\n              EOF\n\n  tags = {\n    Name = "terraform-101-web-instance"\n  }\n}\n')])])]),t("ul",[t("li",[t("strong",[r._v("elb.tf")]),r._v(" 定義 ELB")])]),r._v(" "),t("div",{staticClass:"language-terraform extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[r._v('resource "aws_elb" "web-elb" {\n  name = "terraform-101-elb"\n\n  instances       = ["${aws_instance.web.*.id}"]\n  security_groups = ["${aws_security_group.elb.id}"]\n\n\n  health_check {\n    healthy_threshold = 2\n    unhealthy_threshold = 2\n    timeout = 3\n    interval = 30\n    target = "HTTP:80/"\n  }\n\n  listener {\n    lb_port           = "80"\n    lb_protocol       = "http"\n    instance_port     = "80"\n    instance_protocol = "http"\n  }\n}\n')])])]),t("p",[r._v("執行 terraform 佈署")]),r._v(" "),t("div",{staticClass:"language-bash extra-class"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[r._v("$ terraform init\n$ terraform plan -out"),t("span",{pre:!0,attrs:{class:"token operator"}},[r._v("=")]),r._v("terraform-101-workshop\n$ terraform apply terraform-101-workshop\n")])])]),t("h2",{attrs:{id:"驗證"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#驗證","aria-hidden":"true"}},[r._v("#")]),r._v(" 驗證")]),r._v(" "),t("ul",[t("li",[r._v("連續透過 ELB 訪問 80 port，會 random 兩台 instance。")])]),r._v(" "),t("h2",{attrs:{id:"清場"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#清場","aria-hidden":"true"}},[r._v("#")]),r._v(" 清場")]),r._v(" "),t("div",{staticClass:"language-bash extra-class"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[r._v("$ terraform destroy\n")])])]),t("ul",[t("li",[r._v("確認 EC2 刪除。")]),r._v(" "),t("li",[r._v("確認 ELB 刪除。")]),r._v(" "),t("li",[r._v("確認 Security Groups 刪除。")])])])},[],!1,null,null,null);e.default=n.exports}}]);